{% extends "layout.html" %}

{% block head %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/1.2.2/chartjs-plugin-annotation.min.js" integrity="sha512-HycvvBSFvDEVyJ0tjE2rPmymkt6XqsP/Zo96XgLRjXwn6SecQqsn+6V/7KYev66OshZZ9+f9AttCGmYqmzytiw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
window.onload = function () {
    var myChart;
    const OPTIONS = { year: 'numeric', month: 'short', day: 'numeric' };
    const TODAY = Date.parse(Date());
    const OFFSET = new Date().getTimezoneOffset() * 60000;
    let input = document.querySelector('select');
    if (input) {
        input.addEventListener('change', async function(e) {

            var url = new URL(window.location.href);
            var search_params = url.searchParams;
            search_params.set('vehicle', encodeURIComponent(e.target.value));
            let response = await fetch('/vehicles', {
                method: 'POST',
                body: 'vehicle=' + encodeURIComponent(e.target.value),
                headers: {
                    'Content-type': 'application/x-www-form-urlencoded'
                },
                credentials: 'include',
            });
            let vehicles = await response.json();
            let html = '';
            for (let v in vehicles) {
                html += '<tr><td>' + vehicles[v][3] + '</td><td>' + vehicles[v][2] + '</td><td>' + vehicles[v][1] + '</td><td>' + vehicles[v][0] + '</td></tr>';
            }
            document.getElementById('toChange').innerHTML = html;
            url.search = search_params.toString();
            history.pushState(null, document.title, url);
            document.getElementById('titleToChange').innerHTML = "Vehicle " + e.target.value + ": Latest issues";
            //Vehicle {{vehicle}}: Latest problems
            myChart.destroy();
            do_graph();
        });
    }
    window.addEventListener('popstate', function () {
        window.location = location.href;
    });
    async function graph() {
        let response = await fetch('/vehicles', {
            method: 'POST',
            credentials: 'include',
        });
        let all_inspections = await response.json();
        return all_inspections;
    }
    function do_graph() {
        graph().then(
            function(value) {
                var url = new URL(window.location.href);
                var search_params = url.searchParams;
                var dataset = [];
                var storage = [];
                for(var j=0;j<value.length;j++) {

                    for(var i=0;i<value[j][Object.keys(value[j])[0]]['dates'].length;i++)
                    {
                        x = value[j][Object.keys(value[j])[0]]['dates'][i] + OFFSET;
                        y = value[j][Object.keys(value[j])[0]]['miles'][i];
                        if (x != 0 || y != 0) {
                            var json = {x: x, y: y};
                            storage.push(json);
                        }
                    }
                    if (storage.length > 0) {
                        vehicle = 'vehicle ' + Object.keys(value[j])[0]
                        var randomColor = Math.floor(Math.random()*16777215).toString(16);
                        randomColor = '#' + randomColor;
                        var obj = {label: vehicle, data: storage, fill: false, backgroundColor: randomColor, borderColor: randomColor, showLine: true};
                        storage = [];
                        if (search_params.has('vehicle')) {
                            if (search_params.get('vehicle') == Object.keys(value[j])[0]) {
                                dataset.push(obj);
                            }
                        }
                        else {
                            dataset.push(obj);
                        }

                    }

                }
                const ctx = document.getElementById('myChart');
                const data = {
                    datasets: dataset,
                };
                const config = {
                    type: 'scatter',
                    plugins: ['chartjs-plugin-annotation'],
                    data: data,
                    options: {
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        var label = context.dataset.label || '';
                                        if ((context.dataset.data.length - 1 == context.dataIndex) && context.dataset.data.length > 1) {
                                            label += ' oil change projection';
                                        }

                                        if (label) {
                                            label += ': (' + context.parsed.y + ' miles : ';
                                        }
                                        else {
                                            label += '(' + context.parsed.y + ' miles : ';
                                        }
                                        d = new Date(context.parsed.x)
                                        label += d.toLocaleDateString('en-US', OPTIONS) + ')';
                                        return label;
                                    }
                                }
                            },
                            autocolors: false,
                            annotation: {
                                annotations: [{
                                    type: 'line',
                                    xMin: TODAY,
                                    xMax: TODAY,
                                    label: {
                                        content: "TODAY",
                                        enabled: true,
                                        position: "start",
                                    }
                                }]
                            },
                        },

                        scales: {
                            x: {
                                type: 'linear',
                                title: {
                                    display: true,
                                    text: 'Date',
                                },
                                position: 'bottom',
                                ticks: {
                                    callback: function(val, index) {
                                        d = new Date(val)
                                        return d.toLocaleDateString('en-US', OPTIONS);
                                    },
                                    maxRotation: 0,
                                    autoSkipPadding: 8,
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Mileage',
                                }
                            }
                        }
                    }
                };
                //Chart.register(chartjs-plugin-annotation);
                myChart = new Chart(
                    document.getElementById('myChart'),
                    config
                );

            }
        );
    }
    do_graph();
}
</script>
{% endblock %}

{% block title %}
    List of the vehicles in your fleet
{% endblock %}

{% block main %}

    <div style="text-align:center; max-width:1100px; margin: auto;">
    {% if not vehicle %}
        <h2>Vehicles</h2>
        <table class="table table-hover table-sm">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Mileage of the next oil change</th>
                    <th>Latest Inspection Mileage</th>
                    <th>Latest Inspection Date</th>
                    <th>Projected date of next oil change</th>
                </tr>
            </thead>
            {% for v, i in vehicles.items() %}
            <tbody>
            {% if i[0][0] < i[0][1] %}
                <tr style='cursor: pointer; cursor: hand; background-color:#FF0000;' onclick="window.location='/vehicles?vehicle={{ v }}';">
            {% else %}
                <tr style='cursor: pointer; cursor: hand;' onclick="window.location='/vehicles?vehicle={{ v }}';">
            {% endif %}
                    <td>{{ v }}</td>
                    <td>{{ i[0][0] }}</td>
                    <td>{{ i[0][1] }}</td>
                    <td>{{ i[0][2] }}</td>
                    <td>{{ i[0][3] }}</td>
                </tr>
            </tbody>
            {% endfor %}
        </table>
    </div>
{% else %}
    <h4>View another</h4>
    <form>
        <div class="mb-3"></div>
            <select id="vehicle_selection" class="form-select" name="vehicle" style="width: auto; margin-right:auto; margin-left:auto; margin-bottom:1em">
                {% for v in vehicles %}
                    {% if vehicle == v["number"] %}
                        <option selected value="{{ v["number"] }}">Vehicle {{ v["number"] }}</option>
                    {% else %}
                        <option value="{{ v["number"] }}">Vehicle {{ v["number"] }}</option>
                    {% endif %}
                {% endfor %}
            </select>
        </div>
    </form>
    <div style="text-align:center; max-width:1100px; margin: auto;">
    <h2 id="titleToChange">Vehicle {{vehicle}}: Latest issues</h2>
        <table class="table table-hover table-sm">
            <thead>
                <tr>
                    <th>By</th>
                    <th>Date</th>
                    <th>Item</th>
                    <th>Notes</th>
                </tr>
            </thead>
            <tbody id="toChange">
            {% for i in inspection %}
                <tr>
                    <td>{{ i[3] }}</td>
                    <td>{{ i[2] }}</td>
                    <td>{{ i[1] }}</td>
                    <td>{{ i[0] }}</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
{% endif %}
<canvas id="myChart" max-width="400" max-height="400"></canvas>
{% endblock %}